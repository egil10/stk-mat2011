# Install packages if you haven't already:
# install.packages(c("tidyquant", "tidyverse"))
library(tidyquant)
library(tidyverse)
# 1. Define 15 super liquid, high-market-cap assets
tickers <- c("AAPL", "MSFT", "NVDA", "AMZN", "META",
"GOOGL", "TSLA", "AVGO", "WMT", "JPM",
"XOM", "V", "JNJ", "MA", "COST")
# 2. Set the 2-year rolling window
end_date   <- today()
start_date <- end_date - years(2)
# 3. Fetch the raw pricing data via Yahoo Finance
raw_data <- tq_get(tickers,
get  = "stock.prices",
from = start_date,
to   = end_date)
cls
setwd("C:/Users/ofurn/Dokumenter/Github/stk-mat2011/code/R")
# Install the arrow package for Parquet support if you don't have it
# install.packages("arrow")
library(tidyquant)
library(tidyverse)
library(arrow)
# 1. Define assets and timeframe
tickers <- c("AAPL", "MSFT", "NVDA", "AMZN", "META",
"GOOGL", "TSLA", "AVGO", "WMT", "JPM",
"XOM", "V", "JNJ", "MA", "COST")
end_date   <- today()
start_date <- end_date - years(2)
# 2. Fetch the raw pricing data
raw_data <- tq_get(tickers,
get  = "stock.prices",
from = start_date,
to   = end_date)
# 3. Pivot into a Price Matrix
price_matrix <- raw_data %>%
select(symbol, date, adjusted) %>%
pivot_wider(names_from = symbol, values_from = adjusted) %>%
drop_na()
# 4. Calculate Daily Returns Matrix
returns_matrix <- raw_data %>%
group_by(symbol) %>%
tq_transmute(select     = adjusted,
mutate_fun = periodReturn,
period     = "daily",
col_rename = "daily_return") %>%
pivot_wider(names_from = symbol, values_from = daily_return) %>%
drop_na()
# 5. --- Setup the Save Directory ---
# Check if the directory exists, if not, create it
data_dir <- "../data"
if (!dir.exists(data_dir)) {
dir.create(data_dir, recursive = TRUE)
}
# 6. --- Save the Data ---
# Option A: Save as Parquet (Highly recommended for Python handoff)
write_parquet(price_matrix, file.path(data_dir, "15_asset_prices.parquet"))
write_parquet(returns_matrix, file.path(data_dir, "15_asset_returns.parquet"))
# Option B: Save as CSV (Good to have for quick viewing in Excel/Numbers)
write_csv(price_matrix, file.path(data_dir, "15_asset_prices.csv"))
write_csv(returns_matrix, file.path(data_dir, "15_asset_returns.csv"))
print("Data successfully saved to ../data!")
raw_data
raw_data
view(raw_data)
price_matrix
returns_matrix
view(price_matrix)
install.packages("MSGARCH")
# =============================================================================
# ms_garch.R — Markov-Switching GARCH via MSGARCH
#
# Part 1: Demo on simulated returns with injected high-vol regime.
# Part 2: Applied to tick-level mid-price returns for EURUSD, USDZAR, XAUUSD.
#
# Prerequisites:
#   install.packages(c("MSGARCH", "arrow"))
#
# Run from RStudio with working directory set to code/R/
# or source("code/R/ms_garch.R") from project root.
# =============================================================================
library(MSGARCH)
library(arrow)
# --- Path setup (relative to this script's location) -------------------------
# Works whether you source() from project root or run in RStudio with
# working directory = code/R/
script_dir <- tryCatch(
dirname(sys.frame(1)$ofile),
error = function(e) getwd()
)
# Navigate to project root: code/R/ -> code/ -> project root
project_root <- normalizePath(file.path(script_dir, "..", ".."), mustWork = FALSE)
data_dir     <- file.path(project_root, "code", "data", "processed")
models_dir   <- file.path(project_root, "code", "plots", "models")
plotly_dir   <- file.path(project_root, "code", "plots", "plotly")
dir.create(models_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(plotly_dir, showWarnings = FALSE, recursive = TRUE)
cat("Project root:", project_root, "\n")
cat("Data dir:    ", data_dir, "\n")
cat("Output dirs: ", models_dir, "\n")
cat("             ", plotly_dir, "\n\n")
# =============================================================================
# Part 1: Simulated Returns
# =============================================================================
cat("=== Part 1: Simulated Returns — MS-GARCH ===\n")
set.seed(42)
n <- 1000
returns <- rnorm(n, mean = 0, sd = 1)
# Inject high volatility regime between days 400-600
returns[400:600] <- rnorm(201, mean = 0, sd = 3)
# Create MS-GARCH specification: 2-regime sGARCH, Normal innovations
spec <- CreateSpec(
variance.spec    = list(model = c("sGARCH", "sGARCH")),
distribution.spec = list(distribution = c("norm", "norm")),
switch.spec      = list(do.mix = FALSE)
)
cat("  Fitting MS-GARCH on simulated data...\n")
fit_sim <- FitML(spec = spec, data = returns)
cat("  Summary:\n")
print(summary(fit_sim))
# Extract conditional volatility
vol_sim <- fit_sim@CondVol
cls
# =============================================================================
# ms_garch.R — Markov-Switching GARCH via MSGARCH
#
# Part 1: Demo on simulated returns with injected high-vol regime.
# Part 2: Applied to tick-level mid-price returns for EURUSD, USDZAR, XAUUSD.
#
# Prerequisites:
#   install.packages(c("MSGARCH", "arrow"))
#
# Run from RStudio with working directory set to code/R/
# or source("code/R/ms_garch.R") from project root.
# =============================================================================
library(MSGARCH)
library(arrow)
# --- Path setup (relative to this script's location) -------------------------
# Works whether you source() from project root or run in RStudio with
# working directory = code/R/
script_dir <- tryCatch(
dirname(sys.frame(1)$ofile),
error = function(e) getwd()
)
# Navigate to project root: code/R/ -> code/ -> project root
project_root <- normalizePath(file.path(script_dir, "..", ".."), mustWork = FALSE)
data_dir     <- file.path(project_root, "code", "data", "processed")
models_dir   <- file.path(project_root, "code", "plots", "models")
plotly_dir   <- file.path(project_root, "code", "plots", "plotly")
dir.create(models_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(plotly_dir, showWarnings = FALSE, recursive = TRUE)
cat("Project root:", project_root, "\n")
cat("Data dir:    ", data_dir, "\n")
cat("Output dirs: ", models_dir, "\n")
cat("             ", plotly_dir, "\n\n")
# =============================================================================
# Part 1: Simulated Returns
# =============================================================================
cat("=== Part 1: Simulated Returns — MS-GARCH ===\n")
set.seed(42)
n <- 1000
returns <- rnorm(n, mean = 0, sd = 1)
# Inject high volatility regime between days 400-600
returns[400:600] <- rnorm(201, mean = 0, sd = 3)
# Create MS-GARCH specification: 2-regime sGARCH, Normal innovations
spec <- CreateSpec(
variance.spec    = list(model = c("sGARCH", "sGARCH")),
distribution.spec = list(distribution = c("norm", "norm")),
switch.spec      = list(do.mix = FALSE)
)
cat("  Fitting MS-GARCH on simulated data...\n")
fit_sim <- FitML(spec = spec, data = returns)
cat("  Summary:\n")
print(summary(fit_sim))
# Extract conditional volatility
vol_sim <- Volatility(fit_sim)
# Save fit results to CSV for Python plotting
sim_df <- data.frame(
day     = 1:n,
returns = returns,
cond_vol = as.numeric(vol_sim)
)
sim_csv <- file.path(models_dir, "ms_garch_simulated.csv")
write.csv(sim_df, sim_csv, row.names = FALSE)
cat("  saved", basename(sim_csv), "\n")
# Quick R plot (PDF)
pdf_path <- file.path(models_dir, "ms_garch_simulated.pdf")
pdf(pdf_path, width = 10, height = 6)
par(mfrow = c(2, 1), mar = c(3, 4, 2, 1))
plot(returns, type = "l", col = "steelblue", lwd = 0.7,
main = "Simulated Returns (high-vol injected days 400-600)",
ylab = "Return", xlab = "")
abline(v = c(400, 600), col = "red", lty = 2)
plot(as.numeric(vol_sim), type = "l", col = "darkorange", lwd = 1.2,
main = "MS-GARCH Conditional Volatility",
ylab = "Volatility", xlab = "Day")
dev.off()
cat("  saved", basename(pdf_path), "\n")
# =============================================================================
# Part 2: Tick Data — EURUSD, USDZAR, XAUUSD (January 2026)
# =============================================================================
cat("\n=== Part 2: Tick Data — MS-GARCH ===\n")
# Helper: load Dukascopy bid/ask parquet, compute mid, return data.frame
load_dukascopy_mid <- function(symbol, month = "202601") {
bid_file <- file.path(data_dir, paste0(symbol, "_dukascopy_bid_", month, ".parquet"))
ask_file <- file.path(data_dir, paste0(symbol, "_dukascopy_ask_", month, ".parquet"))
if (!file.exists(bid_file) || !file.exists(ask_file)) {
cat("  WARNING: parquet files not found for", symbol, "\n")
return(NULL)
}
bid <- read_parquet(bid_file)
ask <- read_parquet(ask_file)
# Both have columns: datetime, price
# Merge on nearest timestamp
bid$bid <- bid$price
ask$ask <- ask$price
# Simple approach: use bid timestamps, merge_asof-style
# Since both are sorted by datetime, we just align by index
n_min <- min(nrow(bid), nrow(ask))
df <- data.frame(
datetime = bid$datetime[1:n_min],
mid      = (bid$bid[1:n_min] + ask$ask[1:n_min]) / 2
)
return(df)
}
# Helper: load HistData LAST parquet
load_last <- function(symbol, month = "202601") {
file <- file.path(data_dir, paste0(symbol, "_last_", month, ".parquet"))
if (!file.exists(file)) {
cat("  WARNING: parquet file not found for", symbol, "\n")
return(NULL)
}
df <- read_parquet(file)
df$mid <- df$price
return(df[, c("datetime", "mid")])
}
# Fit MS-GARCH on one pair
fit_pair <- function(pair_name, df, max_pts = 5000) {
cat("  ", pair_name, ": ", nrow(df), " raw ticks\n", sep = "")
mid <- df$mid
log_ret <- diff(log(mid)) * 1e4  # bps
# Remove non-finite values
good <- is.finite(log_ret)
log_ret <- log_ret[good]
times   <- df$datetime[-1][good]
# Subsample for tractable MLE
if (length(log_ret) > max_pts) {
step <- floor(length(log_ret) / max_pts)
idx  <- seq(1, length(log_ret), by = step)
log_ret <- log_ret[idx]
times   <- times[idx]
}
cat("  ", pair_name, ": fitting MS-GARCH on ", length(log_ret), " points...\n", sep = "")
result <- tryCatch({
spec <- CreateSpec(
variance.spec    = list(model = c("sGARCH", "sGARCH")),
distribution.spec = list(distribution = c("norm", "norm")),
switch.spec      = list(do.mix = FALSE)
)
fit <- FitML(spec = spec, data = log_ret)
cat("  Summary for ", pair_name, ":\n", sep = "")
print(summary(fit))
cond_vol <- as.numeric(Volatility(fit))
# Save to CSV for Python/Plotly plotting
out_df <- data.frame(
datetime = times,
log_ret  = log_ret,
cond_vol = cond_vol
)
pair_lc <- tolower(pair_name)
csv_path <- file.path(models_dir, paste0("ms_garch_", pair_lc, "_202601.csv"))
write.csv(out_df, csv_path, row.names = FALSE)
cat("  saved ", basename(csv_path), "\n", sep = "")
# Quick R plot (PDF)
pdf_path <- file.path(models_dir, paste0("ms_garch_", pair_lc, "_202601.pdf"))
pdf(pdf_path, width = 10, height = 6)
par(mfrow = c(2, 1), mar = c(3, 4, 2, 1))
plot(times, log_ret, type = "l", col = "steelblue", lwd = 0.5,
main = paste(pair_name, "— Log-returns (bps)"),
ylab = "bps", xlab = "")
plot(times[1:length(cond_vol)], cond_vol, type = "l",
col = "darkorange", lwd = 1,
main = paste(pair_name, "— MS-GARCH Conditional Volatility"),
ylab = "Volatility", xlab = "")
dev.off()
cat("  saved ", basename(pdf_path), "\n", sep = "")
return(TRUE)
}, error = function(e) {
cat("  ", pair_name, ": MS-GARCH fitting failed — ", conditionMessage(e), "\n", sep = "")
return(FALSE)
})
return(result)
}
# --- Load and fit each pair ---
# EURUSD (Dukascopy bid/ask -> mid)
df_eurusd <- load_dukascopy_mid("eurusd")
if (!is.null(df_eurusd)) fit_pair("EURUSD", df_eurusd)
# USDZAR (Dukascopy bid/ask -> mid)
df_usdzar <- load_dukascopy_mid("usdzar")
if (!is.null(df_usdzar)) fit_pair("USDZAR", df_usdzar)
# XAUUSD (HistData LAST -> mid = last)
df_xauusd <- load_last("xauusd")
if (!is.null(df_xauusd)) fit_pair("XAUUSD", df_xauusd)
cat("\nDone! Outputs saved to:\n")
cat("  PDF: ", models_dir, "\n")
cat("  CSV: ", models_dir, " (for Python/Plotly plotting)\n")
remotes::install_github("anthonynorth/rscodeio")
install.packages("remotes")
library(remotes)
remotes::install_github("anthonynorth/rscodeio")
options(prompt = "R> ", continue = "+ ", width = 60,
+ digits = 4, show.signif.stars = FALSE,
library(speed1)
data(speed1)
library(tidyverse)
data("faithfuld")
faithful
faithfuld
install.packages("speed1")
library(speed1)
?speed1
??speed1
library(tidyverse)
library(depmixS4)
library(hmmr)
install.packages("hmmr")
library(tidyverse)
library(depmixS4)
library(hmmr)
data("speed1")
speed1
speed1 %>% autoplot()
library(fpp3)
library(fpp3)
speed1
speed1 %>% autoplot()
speed1
speed1 %>%
ggplot(aes(x = Pacc)) +
geom_density()
speed1 %>%
ggplot() +
geom_density(aes(x = Pacc))
speed1 %>%
ggplot() +
geom_density(aes(x = Pacc)) +
geom_density(aes(x = RT))
speed1 %>%
ggplot() +
geom_density(aes(x = RT))
data("sp500")
sp500
sp500 %>% as_tibble()
sp500
install.packages("TTR")
nti = attr(disc42, "ntimes")
data("disc42")
data("disc42")
nti = attr(disc42, "ntimes")
nti
data("discrimination")
discrimination
